@inherits VerbQuizBase
@page "/VerbQuiz"
@using savoir.globals

<PageTitle>Verb Quiz</PageTitle>

<div class="VerbQuiz">
    <div class="VerbQuiz__header" >
        <h2 id="VerbQuiz__infinitive" @onclick="DisplayEnglishTranslation">@topText</h2>
        <h3 id="VerbQuiz__tense">@verbQuiz.verbinfo[2]</h3>
    </div>
    <div class="VerbQuiz__inputs">
        <form onsubmit="return false" autocomplete="off">
            <table class="VerbQuiz__table">
                <colgroup>
                    <col span="1" style="width: 33.3%;">
                    <col span="1" style="width: 33.3%;">
                    <col span="1" style="width: 16.7%;">
                    <col span="1" style="width: 16.7%;">
                </colgroup>
                <tr>
                    <td>
                        <label for="je" class="VerbQuiz__pronouns">@textJe</label>
                    </td>
                    <td>
                        <input type="text" id="je" class="VerbQuiz__input" name="VerbQuiz__je" disabled="@userInputDisabled" autocomplete="off" value="@verbQuiz.userVerbs[0]" @oninput="((e) => OnTextChange(e, 0))">
                    </td>
                    <td>

                    </td>
                    <td>
                        @if (displayCorrections)
                        {
                            if (verbQuiz.userVerbs[0] == verbQuiz.conjugations[0])
                            {
                                <img class="correction-img" src="images/tick.png" />
                            }
                            else
                            {
                                <label id='je__result' class="result">@CorrectionsText(0)</label>
                            }
                        }
                    </td>
                </tr>

                <tr>
                    <td>
                        <label for="tu" class="VerbQuiz__pronouns">Tu</label>
                    </td>
                    <td>
                        <input type="text" id="tu" class="VerbQuiz__input" name="VerbQuiz__tu" disabled="@userInputDisabled" autocomplete="off" value="@verbQuiz.userVerbs[1]" @oninput="((e) => OnTextChange(e, 1))">
                    </td>
                    <td>
                        @if (selectedField == 0)
                        {
                            <img class="correction-img" src="images/copy.png" @onclick="(e => ClipboardClicked(1))"/>
                        }
                    </td>
                    <td>
                        @if (displayCorrections)
                        {
                            if (verbQuiz.userVerbs[1] == verbQuiz.conjugations[1])
                            {
                                <img class="correction-img" src="images/tick.png" />
                            }
                            else
                            {
                                <label id='tu__result' class="result">@CorrectionsText(1)</label>
                            }
                        }
                    </td>
                </tr>

                <tr>
                    <td>
                        <label for="il" class="VerbQuiz__pronouns">Il/elle/on</label>
                    </td>
                    <td>
                        <input type="text" id="il" class="VerbQuiz__input" name="VerbQuiz__il" disabled="@userInputDisabled" autocomplete="off" value="@verbQuiz.userVerbs[2]" @oninput="((e) => OnTextChange(e, 2))">
                    </td>
                    <td>
                        @if (selectedField == 1)
                        {
                            <img class="correction-img" src="images/copy.png" @onclick="(e => ClipboardClicked(2))"/>
                        }
                    </td>
                    <td>
                        @if (displayCorrections)
                        {
                            if (verbQuiz.userVerbs[2] == verbQuiz.conjugations[2])
                            {
                                <img class="correction-img" src="images/tick.png" />
                            }
                            else
                            {
                                <label id='il__result' class="result">@CorrectionsText(2)</label>
                            }
                        }
                    </td>
                </tr>

                <tr>
                    <td>
                        <label for="nous" class="VerbQuiz__pronouns">Nous</label>
                    </td>
                    <td>
                        <input type="text" id="nous" class="VerbQuiz__input" name="VerbQuiz__nous" disabled="@userInputDisabled" autocomplete="off" value="@verbQuiz.userVerbs[3]" @oninput="((e) => OnTextChange(e, 3))">
                    </td>
                    <td>
                        @if (selectedField == 2)
                        {
                            <img class="correction-img" src="images/copy.png" @onclick="(e => ClipboardClicked(3))" />
                        }
                    </td>
                    <td>
                        @if (displayCorrections)
                        {
                            if (verbQuiz.userVerbs[3] == verbQuiz.conjugations[3])
                            {
                                <img class="correction-img" src="images/tick.png" />
                            }
                            else
                            {
                                <label id='nous__result' class="result">@CorrectionsText(3)</label>
                            }
                        }
                    </td>
                </tr>

                <tr>
                    <td>
                        <label for="vous" class="VerbQuiz__pronouns">Vous</label>
                    </td>
                    <td>
                        <input type="text" id="vous" class="VerbQuiz__input" name="VerbQuiz__vous"disabled="@userInputDisabled" autocomplete="off" value="@verbQuiz.userVerbs[4]" @oninput="((e) => OnTextChange(e, 4))">
                    </td>
                    <td>
                        @if (selectedField == 3)
                        {
                            <img class="correction-img" src="images/copy.png" @onclick="(e => ClipboardClicked(4))" />
                        }
                    </td>
                    <td>
                        @if (displayCorrections)
                        {
                            if (verbQuiz.userVerbs[4] == verbQuiz.conjugations[4])
                            {
                                <img class="correction-img" src="images/tick.png" />
                            }
                            else
                            {
                                <label id='vous__result' class="result">@CorrectionsText(4)</label>
                            }
                        }
                    </td>
                </tr>

                <tr>
                    <td>
                        <label for="ils" class="VerbQuiz__pronouns">Ils/elles</label>
                    </td>
                    <td>
                        <input type="text" id="ils" class="VerbQuiz__input" name="VerbQuiz__ils" disabled="@userInputDisabled" autocomplete="off" value="@verbQuiz.userVerbs[5]" @oninput="((e) => OnTextChange(e, 5))">
                    </td>
                    <td>
                        @if (selectedField == 4)
                        {
                            <img class="correction-img" src="images/copy.png" @onclick="(e => ClipboardClicked(5))" />
                        }
                    </td>
                    <td>
                        @if (displayCorrections)
                        {
                            if (verbQuiz.userVerbs[5] == verbQuiz.conjugations[5])
                            {
                                <img class="correction-img" src="images/tick.png" />
                            }
                            else
                            {
                                <label id='ils__result' class="result">@CorrectionsText(5)</label>
                            }
                        }
                    </td>
                </tr>
            </table>

            <button type="submit" class="Quiz__submit" id="VerbQuiz__submit" @onclick="ResetVerb">@buttonLabels[buttonLabelIndex]</button>
        </form> 
    </div>
</div>

<AccentBox AccentMenuHidden="accentMenuHidden" OnClick="OnAccentClicked"/>

@code {
    public VerbQuizBase verbQuiz; 

    public string[] buttonLabels = new string[2] { "Submit", "Next" };
    public int buttonLabelIndex = 0;
    public bool userInputDisabled = false;

    public bool displayCorrections = false;
    public string textJe = "Je";

    public bool accentMenuHidden = true;
    public int selectedField = -1;

    public string topText;

    public VerbQuiz()
    {
        verbQuiz = new VerbQuizBase();
        // on creating the VerbQuiz page, we use the set selected + tenses selected to store the possible verbs/tenses.
        verbQuiz.possibleVerbs = GLOBALS.VerbsSelectedList.ToArray();
        verbQuiz.possibleTenses = GLOBALS.TensesSelectedList.ToArray();

        verbQuiz.RandomVerb();
        topText = verbQuiz.verbinfo[0];
    }

    public void ResetVerb()
    {
        // if all user input fields are filled, execute IF block
        if (verbQuiz.userVerbs.All(x => x != ""))
        {
            // if SUBMIT button clicked:
            if (buttonLabelIndex == 0)
            {
                buttonLabelIndex = 1;

                userInputDisabled = true;

                displayCorrections = true;
            }

            // if NEXT button clicked:
            else 
            {
                buttonLabelIndex = 0;

                userInputDisabled = false;

                // reset the user input fields (which are bound to indexes of userVerbs)
                for (int i = 0; i<=5; i++)
                {
                    verbQuiz.userVerbs[i] = string.Empty;
                }

                displayCorrections = false;

                // generate a new verb + tense
                verbQuiz.RandomVerb();
                topText = verbQuiz.verbinfo[0];
            }
        } 
    }

    public string CorrectionsText(int i)
    {
        return (displayCorrections) ? verbQuiz.conjugations[i] : string.Empty;
    }

    public void OnTextChange(ChangeEventArgs args, int i)
    {
        if (args.Value.ToString() is not null)
        {
            verbQuiz.userVerbs[i] = args.Value.ToString();
        }

        // need to check last element of non-zero length array
        if (verbQuiz.userVerbs[i].Length != 0)
        {
            if (verbQuiz.userVerbs[i].Contains('#'))
            {
                // if the user types an # symbol, display the accent box GUI and prevent further text input
                accentMenuHidden = false;
                userInputDisabled = true;
            }
        }

        selectedField = i;

        if (i == 0)
        {
            // update the subject field "je" to "j' " if first letter is vowel
            textJeChanged();
        }
    }

    public void OnAccentClicked(char accentClicked)
    {
        if (accentClicked == '#')
        {
            verbQuiz.userVerbs[selectedField] = verbQuiz.userVerbs[selectedField].Replace("#", "");
        }
        else
        {
            verbQuiz.userVerbs[selectedField] = verbQuiz.userVerbs[selectedField].Replace('#', accentClicked);
        }

        accentMenuHidden = true;
        userInputDisabled = false;
    }

    public void textJeChanged()
    {
        char[] frenchVowels = new char[6] { 'a', 'e', 'i', 'o', 'u', 'h' };

        if (verbQuiz.userVerbs[0].Length > 0)
        {
            if (frenchVowels.Contains(verbQuiz.userVerbs[0][0]))
            {
                textJe = "J'";
            }
            else
            {
                textJe = "Je";
            }
        }
        else
        {
            textJe = "Je";
        }

    }

    public async Task DisplayEnglishTranslation()
    {
        topText = verbQuiz.verbinfo[1];

        await Task.Delay(3000);

        await InvokeAsync(() => StateHasChanged());

        topText = verbQuiz.verbinfo[0];
    }

    public void ClipboardClicked(int i)
    {
        if (i >= 1 && i <= 5)
        {
            verbQuiz.userVerbs[i] = verbQuiz.userVerbs[i - 1];
            selectedField = i;
        }
    }
}